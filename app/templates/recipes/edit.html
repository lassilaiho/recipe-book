{% extends "layout.html" %}

{% block body %}
<form method="POST" action="{{ save_action }}" onsubmit="onSubmit(event)">
    <div class="form-group">
        {{ form.name.label }}
        {{ form.name(id='name', class='form-control') }}
        {% for error in form.name.errors %}
        <p class="text-danger">{{ error }}</p>
        {% endfor %}
    </div>
    <div class="form-group">
        {{ form.description.label }}
        {{ form.description(id='description', rows='5', class='form-control') }}
        {% for error in form.description.errors %}
        <p class="text-danger">{{ error }}</p>
        {% endfor %}
    </div>
    <div class="form-group">
        <div class="d-flex mb-2">
            <span class="mr-auto">Ingredients</span>
        </div>
        <div>
            {% for error in form.ingredient_amounts.errors %}
            {% if is_str(error) %}
            <p class="text-danger">{{ error }}</p>
            {% endif %}
            {% endfor %}
        </div>
        <div id="common-ingredient-list" class="ml-4"></div>
        <div id="grouped-ingredient-list"></div>
        <div class="d-flex mb-2 justify-content-end">
            <button type="button" class="btn btn-success mr-2"
                onclick="addGroup()">
                Add group
            </button>
            <button type="button" class="btn btn-success"
                onclick="addIngredient()">
                Add ingredient
            </button>
        </div>
    </div>
    <div class="form-group">
        {{ form.steps.label }}
        {{ form.steps(id='steps', rows='5', class='form-control') }}
        {% for error in form.steps.errors %}
        <p class="text-danger">{{ error }}</p>
        {% endfor %}
    </div>
    <div class="form-group d-flex justify-content-end">
        <button class="btn btn-primary mr-2" type="submit">
            Save
        </button>
        <a class="btn btn-secondary" href="{{ cancel_action }}">
            Cancel
        </a>
    </div>
    {{ form.csrf_token }}
</form>
<template id="group-template">
    <div>
        <div class="form-inline pb-2 align-items-start">
            <img src="/static/img/vertical-dots.svg" alt="" width="32"
                height="32" title="Reorder" draggable="false" class="handle">
            <input class="form-control group-input flex-grow-1" type="text"
                value="" placeholder="Group name" draggable="true"
                ondragstart="disableDrag(event)" />
            <button type="button" class="btn btn-danger ml-2" draggable="true"
                ondragstart="disableDrag(event)" onclick="removeGroup(event)">
                Remove
            </button>
        </div>
        <div class="group-error-display text-danger"></div>
        <div class="ingredient-list pl-4" draggable="true"
            ondragstart="disableDrag(event)"></div>
    </div>
</template>
<template id="ingredient-template">
    <div class="form-inline pb-2 align-items-start">
        <img src="/static/img/vertical-dots.svg" alt="" width="32" height="32"
            title="Reorder" draggable="false" class="handle">
        <div class="d-flex flex-column" draggable="true"
            ondragstart="disableDrag(event)">
            <input class="form-control amount-input" type="text" value=""
                placeholder="Amount">
            <div class="amount-error-display text-danger"></div>
        </div>
        <div class="d-flex flex-column flex-grow-1 mx-2" draggable="true"
            ondragstart="disableDrag(event)">
            <input class="form-control name-input" required="" type="text"
                value="" placeholder="Ingredient">
            <div class="name-error-display text-danger"></div>
        </div>
        <datalist></datalist>
        <input class="ingredient-group-input d-none" type="text" value="" />
        <button type="button" class="btn btn-danger" draggable="true"
            ondragstart="disableDrag(event)" onclick="removeIngredient(event)">
            Remove
        </button>
    </div>
</template>
<style>
    .handle {
        cursor: grab;
    }
</style>
<script>
    let ingredientList, commonIngredientList, ingredientTemplate,
        groupList, groupListElement, groupTemplate,
        idCounter = 0;
    const completers = new Map(),
        initialValues = {{ ingredient_data| tojson }};

    document.addEventListener("DOMContentLoaded", () => {
        ingredientTemplate = document.getElementById("ingredient-template");
        groupTemplate = document.getElementById("group-template");

        groupListElement = document.getElementById("grouped-ingredient-list");
        commonIngredientList = document.getElementById("common-ingredient-list");
        groupList = new SortableList("groups", groupListElement);
        ingredientList = new SortableList("ingredients", commonIngredientList);
        for (const group of initialValues) {
            if (group.name === "") {
                group.ingredients.forEach(x => addIngredient(x, commonIngredientList));
            } else {
                addGroup(group);
                group.ingredients.forEach(x => addIngredient(x));
            }
        }
    });

    function addIngredient(value, parent) {
        const id = idCounter++;
        const [row, completer] = createIngredientRow(
            id,
            value ?? {
                amount: "",
                amountErrors: [],
                name: "",
                nameErrors: [],
            }
        );
        if (parent === undefined) {
            parent = groupListElement.children.length === 0
                ? commonIngredientList
                : groupListElement.lastElementChild
                    .querySelector(".ingredient-list");
        }
        parent.append(row);
        completers.set(id, completer);
    }

    function removeIngredient(event) {
        const row = event.target.parentNode;
        const id = parseInt(row.dataset.id);
        row.remove();
        completers.get(id).dispose();
        completers.delete(id);
    }

    function createIngredientRow(id, data) {
        const row = ingredientTemplate.content.cloneNode(true);
        row.firstElementChild.dataset.id = id;
        row.firstElementChild.id = `ingredient-${id}`;
        row.querySelector(".amount-input").value = data.amount;
        const nameInput = row.querySelector(".name-input");
        nameInput.value = data.name;
        const dataList = row.querySelector("datalist");
        dataList.id = `datalist-${id}`;
        const completer = new Autocompleter(
            "{{ url_for('ingredient_completions') }}",
            nameInput,
            dataList,
        );
        displayErrors(
            row.querySelector(".amount-error-display"),
            data.amountErrors,
        );
        displayErrors(
            row.querySelector(".name-error-display"),
            data.nameErrors,
        );
        return [row, completer];
    }

    function addGroup(value) {
        const row = createGroupRow(
            idCounter++,
            value ?? {
                name: "",
                errors: [],
            },
        );
        groupListElement.append(row);
        ingredientList.observeParent(row.querySelector(".ingredient-list"));
    }

    function removeGroup(event) {
        event.target.parentNode.parentNode.remove();
    }

    function createGroupRow(id, data) {
        const row = groupTemplate.content.cloneNode(true);
        row.firstElementChild.id = `group-${id}`;
        row.querySelector(".group-input").value = data.name;
        displayErrors(
            row.querySelector(".group-error-display"),
            data.errors,
        );
        return row.firstElementChild;
    }

    function displayErrors(element, errors) {
        for (let i = 0; i < errors.length; i++) {
            if (i > 0) {
                element.append(document.createElement("br"));
            }
            element.append(errors[i]);
        }
    }

    function onSubmit(event) {
        let i = 0;
        const prepareForSubmit = (parent, group) => {
            const amounts = parent.querySelectorAll(".amount-input");
            const names = parent.querySelectorAll(".name-input");
            const groups = parent.querySelectorAll(".ingredient-group-input");
            for (let j = 0; j < amounts.length; j++, i++) {
                amounts[j].name = `ingredient_amounts-${i}-amount`;
                names[j].name = `ingredient_amounts-${i}-name`;
                groups[j].name = `ingredient_amounts-${i}-group`;
                groups[j].value = group;
            }
        };
        prepareForSubmit(commonIngredientList, "");
        for (const group of groupListElement.children) {
            prepareForSubmit(group, group.querySelector(".group-input").value);
        }

        const amounts = event.target.querySelectorAll(".amount-input");
        const names = event.target.querySelectorAll(".name-input");
        for (let i = 0; i < amounts.length; i++) {
            amounts[i].name = `ingredient_amounts-${i}-amount`;
            names[i].name = `ingredient_amounts-${i}-name`;
        }
    }

    function disableDrag(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    class SortableList {
        constructor(listId, ...parents) {
            this.listId = listId;
            this.onChange = this.onChange.bind(this);
            this.observers = [];
            for (const parent of parents) {
                parent.childNodes.forEach(this.makeDraggable, this);
                this.observeParent(parent);
            }
        }

        dispose() {
            this.observers.forEach(x => x.disconnect());
        }

        onChange(records) {
            for (const record of records) {
                for (const node of record.addedNodes) {
                    this.makeDraggable(node);
                }
            }
        }

        observeParent(parent) {
            const observer = new MutationObserver(this.onChange);
            observer.observe(parent, { childList: true });
            this.observers.push(observer);
        }

        makeDraggable(item) {
            item.draggable = true;
            item.addEventListener("dragstart", event => {
                event.stopPropagation();
                event.dataTransfer.effectAllowed = "move";
                event.dataTransfer.setData(item.id, "");
                event.dataTransfer.setData(this.listId, "");
                setTimeout(() => item.style.visibility = "hidden", 0);
            });
            item.addEventListener("dragend", event => {
                item.style.visibility = "unset";
            });
            item.addEventListener("dragenter", e => {
                if (e.dataTransfer.types[1] === this.listId) {
                    e.preventDefault();
                }
            });
            item.addEventListener("dragover", event => {
                if (event.dataTransfer.types[1] !== this.listId) {
                    return;
                }
                event.preventDefault();
                const draggedId = event.dataTransfer.types[0];
                const rect = item.getBoundingClientRect();
                if (event.clientY - rect.top < rect.height / 2
                    && item.previousElementSibling?.id !== draggedId
                ) {
                    const draggedItem = document.getElementById(draggedId);
                    item.parentNode.insertBefore(draggedItem, item);
                } else if (item.nextElementSibling?.id !== draggedId) {
                    const draggedItem = document.getElementById(draggedId);
                    item.parentNode.insertBefore(draggedItem, item.nextElementSibling);
                }
            });
        }
    }

</script>
<script src="/static/js/autocomplete.js"></script>
{% endblock %}
