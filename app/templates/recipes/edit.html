{% extends "layout.html" %}

{% block body %}
<form method="POST" action="{{ save_action }}" onsubmit="onSubmit(event)">
    <div class="form-group">
        {{ form.name.label }}
        {{ form.name(id='name', class='form-control') }}
        {% for error in form.name.errors %}
        <p class="text-danger">{{ error }}</p>
        {% endfor %}
    </div>
    <div class="form-group">
        {{ form.description.label }}
        {{ form.description(id='description', rows='5', class='form-control') }}
        {% for error in form.description.errors %}
        <p class="text-danger">{{ error }}</p>
        {% endfor %}
    </div>
    <div class="form-group">
        <div class="d-flex mb-2">
            <span class="mr-auto">Ingredients</span>
        </div>
        <div>
            {% for error in form.ingredient_amounts.errors %}
            {% if is_str(error) %}
            <p class="text-danger">{{ error }}</p>
            {% endif %}
            {% endfor %}
        </div>
        <div id="ingredient-list"></div>
        <div class="d-flex mb-2 justify-content-end">
            <button type="button" class="btn btn-success"
                onclick="addIngredient()">
                Add ingredient
            </button>
        </div>
    </div>
    <div class="form-group">
        {{ form.steps.label }}
        {{ form.steps(id='steps', rows='5', class='form-control') }}
        {% for error in form.steps.errors %}
        <p class="text-danger">{{ error }}</p>
        {% endfor %}
    </div>
    <div class="form-group d-flex justify-content-end">
        <button class="btn btn-primary mr-2" type="submit">
            Save
        </button>
        <a class="btn btn-secondary" href="{{ cancel_action }}">
            Cancel
        </a>
    </div>
    {{ form.csrf_token }}
</form>
<template id="ingredient-row-template">
    <div class="form-inline pb-2 align-items-start">
        <img src="/static/img/vertical-dots.svg" alt="" width="32" height="32"
            title="Reorder" draggable="false" class="handle">
        <div class="d-flex flex-column">
            <input class="form-control amount-input" type="text" value=""
                placeholder="Amount">
            <div class="amount-error-display text-danger"></div>
        </div>
        <div class="d-flex flex-column flex-grow-1 mx-2">
            <input class="form-control name-input" required="" type="text"
                value="" placeholder="Ingredient">
            <div class="name-error-display text-danger"></div>
        </div>
        <datalist></datalist>
        <button type="button" class="btn btn-danger"
            onclick="removeIngredient(event)">
            Remove
        </button>
    </div>
</template>
<style>
    .handle {
        cursor: grab;
    }
</style>
<script>
    let ingredientList, ingredientRowTemplate;
    let idCounter = 0;
    const completers = new Map();
    const ingredients = {{ ingredient_data| tojson }};

    document.addEventListener("DOMContentLoaded", () => {
        ingredientList = new SortableList(document.getElementById("ingredient-list"));
        ingredientRowTemplate = document.getElementById("ingredient-row-template");

        ingredients.initialValues.forEach(addIngredient);
    });

    function addIngredient(value) {
        if (value === undefined) {
            value = {
                "amount": "",
                "amountErrors": [],
                "name": "",
                "nameErrors": [],
            };
        }
        const id = idCounter++;
        const [row, completer] = createIngredientRow(id, value);
        ingredientList.list.append(row);
        completers.set(id, completer);
    }

    function removeIngredient(event) {
        const row = event.target.parentNode;
        const id = parseInt(row.dataset.id);
        row.remove();
        completers.get(id).dispose();
        completers.delete(id);
    }

    function createIngredientRow(id, data) {
        const row = ingredientRowTemplate.content.cloneNode(true);
        row.firstElementChild.dataset.id = id;
        row.firstElementChild.id = `ingredient-${id}`;
        row.querySelector(".amount-input").value = data.amount;
        const nameInput = row.querySelector(".name-input");
        nameInput.value = data.name;
        const dataList = row.querySelector("datalist");
        dataList.id = `datalist-${id}`;
        const completer = new Autocompleter(
            "{{ url_for('ingredient_completions') }}",
            nameInput,
            dataList,
        );
        displayErrors(
            row.querySelector(".amount-error-display"),
            data.amountErrors,
        );
        displayErrors(
            row.querySelector(".name-error-display"),
            data.nameErrors,
        );
        return [row, completer];
    }

    function displayErrors(element, errors) {
        for (let i = 0; i < errors.length; i++) {
            if (i > 0) {
                element.append(document.createElement("br"));
            }
            element.append(errors[i]);
        }
    }

    function onSubmit(event) {
        const amounts = event.target.querySelectorAll(".amount-input");
        const names = event.target.querySelectorAll(".name-input");
        for (let i = 0; i < amounts.length; i++) {
            amounts[i].name = `ingredient_amounts-${i}-amount`;
            names[i].name = `ingredient_amounts-${i}-name`;
        }
    }

    class SortableList {
        constructor(list) {
            this.list = list;
            list.childNodes.forEach(this.makeDraggable, this);
            this.observer = new MutationObserver(this.onChange.bind(this));
            this.observer.observe(list, { childList: true });
        }

        dispose() {
            this.observer.disconnect();
        }

        onChange(records) {
            for (const record of records) {
                for (const node of record.addedNodes) {
                    this.makeDraggable(node);
                }
            }
        }

        makeDraggable(item) {
            item.draggable = true;
            item.addEventListener("dragstart", event => {
                event.dataTransfer.effectAllowed = "move";
                event.dataTransfer.setData(item.id, "");
                setTimeout(() => item.style.visibility = "hidden", 0);
            });
            item.addEventListener("dragend", event => {
                const item = event.target;
                item.style.visibility = "visible";
            });
            item.addEventListener("dragenter", e => e.preventDefault());
            item.addEventListener("dragover", event => {
                event.preventDefault();
                const draggedId = event.dataTransfer.types[0];
                const rect = item.getBoundingClientRect();
                if (event.clientY - rect.top < rect.height / 2) {
                    if (item.previousElementSibling?.id !== draggedId) {
                        const draggedItem = document.getElementById(draggedId);
                        this.list.insertBefore(draggedItem, item);
                    }
                } else {
                    const next = item.nextElementSibling;
                    if (next?.id !== draggedId) {
                        const draggedItem = document.getElementById(draggedId);
                        this.list.insertBefore(draggedItem, next);
                    }
                }
            });
        }
    }

</script>
<script src="/static/js/autocomplete.js"></script>
{% endblock %}
