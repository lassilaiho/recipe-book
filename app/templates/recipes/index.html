{% extends "layout.html" %}

{% from "delete-modal.html" import delete_modal %}

{% block body %}
<h1>Recipes</h1>
<div class="d-flex">
    <a class="btn btn-success" href="{{ url_for('create_recipe_form') }}">
        Add recipe
    </a>
    <form id="search-form" class="form-inline ml-auto" method="GET"
        action="{{ url_for('get_recipes') }}" onsubmit="onSearch()">
        {{ form.q(class="form-control", placeholder=form.q.label.text) }}
        {{ form.p(class="d-none", value=1) }}
        <button type="submit" class="btn btn-primary ml-2">
            Search
        </button>
        <div class="dropdown ml-2">
            <button class="btn btn-secondary dropdown-toggle" type="button"
                data-toggle="dropdown">
                Filters
            </button>
            <div class="dropdown-menu p-2 search-filters"
                onclick="stopPropagation(event)">
                <div class="d-flex flex-column align-items-start">
                    <div class="form-check">
                        {{ form.no_name(class="form-check-input") }}
                        {{ form.no_name.label }}
                    </div>
                    <div class="form-check">
                        {{ form.no_description(class="form-check-input") }}
                        {{ form.no_description.label }}
                    </div>
                    <div class="form-check">
                        {{ form.no_steps(class="form-check-input") }}
                        {{ form.no_steps.label }}
                    </div>
                </div>
            </div>
        </div>
        {% if form.q.data %}
        <button type="submit" class="btn btn-secondary ml-2"
            onclick="showAll()">
            Show all
        </button>
        {% endif %}
    </form>
</div>
<div class="d-flex flex-wrap mt-2">
    {% for recipe in pagination.items %}
    {% if recipe.name %}
    {% set display_name = recipe.name %}
    {% else %}
    {% set display_name = "Unnamed recipe" %}
    {% endif %}
    <div class="card m-1 recipe-card">
        <div class="card-body d-flex flex-column">
            <h5 class="card-title limit-lines _2">
                {{ display_name }}
            </h5>
            <p class="card-text limit-lines _5">
                {{ recipe.description }}
            </p>
            <div class="d-flex justify-content-end mt-auto">
                <a class="btn btn-primary mr-2"
                    href="{{ url_for('get_recipe', recipe_id=recipe.id) }}">
                    Details
                </a>
                <button type="button" class="btn btn-danger" data-toggle="modal"
                    data-target="#delete-modal"
                    data-recipe-name="{{ display_name }}"
                    data-action="{{ url_for('delete_recipe', recipe_id=recipe.id) }}">
                    Delete
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <p>No recipes matched the search criteria.</p>
    {% endfor %}
</div>
<ul class="pagination justify-content-end mt-2">
    <li class="page-item {{ '' if pagination.has_prev else 'disabled' }}">
        <button type="submit" class="page-link" onclick="toPage(event)"
            form="search-form" data-page="{{ pagination.prev_num }}">
            Previous
        </button>
    </li>
    {% for page in pagination.iter_pages() %}
    {% if page %}
    <li class="page-item {{ 'active' if page == pagination.page else '' }}">
        <button type="submit" class="page-link" onclick="toPage(event)"
            form="search-form" data-page="{{ page }}">
            {{ page }}
        </button>
    </li>
    {% else %}
    <li class="page-item">
        <a href="#" class="page-link">&hellip;</a>
    </li>
    {% endif %}
    {% endfor %}
    <li class="page-item {{ '' if pagination.has_next else 'disabled' }}">
        <button type="submit" class="page-link" onclick="toPage(event)"
            form="search-form" data-page="{{ pagination.next_num }}">
            Next
        </button>
    </li>
</ul>
<form id="delete-recipe-form" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
</form>
{{ delete_modal(id='delete-modal', title='Delete recipe')}}
<style>
    .recipe-card {
        width: 18rem;
    }

    .limit-lines {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
    }

    .limit-lines._2 {
        -webkit-line-clamp: 2;
    }

    .limit-lines._5 {
        -webkit-line-clamp: 5;
    }
</style>
<script>
    let searchInput, pageInput, searchFilters;
    document.addEventListener("DOMContentLoaded", () => {
        searchInput = document.getElementById("q");
        pageInput = document.getElementById("p");
        searchFilters =
            document.querySelectorAll(".search-filters input[type=checkbox]");

        $("#delete-modal").on("show.bs.modal", function (e) {
            const button = $(e.relatedTarget);
            const name = button.data("recipe-name");
            const bodyText =
                `Are you sure you want to permanently delete ${name}?`;

            const modal = $(this);
            modal.find(".modal-body p").text(bodyText);
            modal.find("form").attr("action", button.data("action"));
        });
    });

    function onSearch() {
        for (const filter of searchFilters) {
            filter.checked = !filter.checked;
        }
    }

    function showAll() {
        searchInput.value = "";
        for (const filter of searchFilters) {
            filter.checked = true;
        }
    }

    function toPage(e) {
        pageInput.value = e.target.dataset.page;
    }

    function stopPropagation(e) {
        e.stopPropagation();
    }
</script>
{% endblock %}
